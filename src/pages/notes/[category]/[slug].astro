---
import { getCollection } from "astro:content";
import path from "node:path";
import ImageWrapper from "@components/misc/ImageWrapper.astro";
import Markdown from "@components/misc/Markdown.astro";
import MainGridLayout from "@layouts/MainGridLayout.astro";
import { Icon } from "astro-icon/components";

function getDir(p: string): string {
	const lastSlash = p.lastIndexOf("/");
	return lastSlash !== -1 ? p.substring(0, lastSlash) : "";
}

export async function getStaticPaths() {
	const notes = await getCollection("notes");
	return notes.map((note) => {
		const category = note.data.category;
		const slugParts = note.slug.split("/");
		const slug = slugParts[slugParts.length - 1].replace(/\.md$/, "");

		return {
			params: { category, slug },
			props: { note, category, slug },
		};
	});
}

const { note, category, slug } = Astro.props;
const { Content, headings } = await note.render();

// 获取同课程的所有笔记（非 draft），按 order 排序
const allNotes = (await getCollection("notes")).filter(
	(n) => n.data.category === category && !n.data.draft,
);
allNotes.sort((a, b) => (a.data.order ?? 999) - (b.data.order ?? 999));

// 根据 clean slug 找到当前索引
const currentIndex = allNotes.findIndex(
	(n) => (n.slug.split("/").pop() ?? "").replace(/\.md$/, "") === slug,
);
const prevNote = currentIndex > 0 ? allNotes[currentIndex - 1] : null;
const nextNote =
	currentIndex < allNotes.length - 1 ? allNotes[currentIndex + 1] : null;

// JSON-LD
const jsonLd = {
	"@context": "https://schema.org",
	"@type": "LearningResource",
	name: note.data.title,
	description: note.data.description,
	datePublished: note.data.date?.toISOString?.(),
	keywords: note.data.tags?.join(", "),
	learningResourceType: "Course Material",
	educationalLevel: category,
};
---

<MainGridLayout 
  banner={note.data.image}
  title={note.data.title} 
  description={note.data.description}
  headings={headings}
>
  <script is:inline slot="head" type="application/ld+json" set:html={JSON.stringify(jsonLd)}></script>

  <!-- 笔记内容 -->
  <div class="flex w-full rounded-[var(--radius-large)] overflow-hidden relative mb-4">
    <div id="post-container" class="card-base z-10 px-6 md:px-9 pt-6 pb-4 relative w-full">
      
      <!-- 面包屑导航 -->
      <div class="flex flex-row text-black/30 dark:text-white/30 gap-2 mb-3 transition onload-animation text-sm">
        <a href="/notes/" class="hover:text-[oklch(0.7_0.14_var(--hue))] transition-colors">
          笔记
        </a>
        <span>/</span>
        <a 
          href={`/notes/${category}/`}
          class="hover:text-[oklch(0.7_0.14_var(--hue))] transition-colors"
        >
          {category}
        </a>
      </div>

      <!-- 标题 -->
      <div class="relative onload-animation">
        <div
          data-pagefind-body data-pagefind-weight="10" data-pagefind-meta="title"
          class="transition w-full block font-bold mb-3
          text-3xl md:text-[2.25rem]/[2.75rem]
          text-black/90 dark:text-white/90
          md:before:w-1 before:h-5 before:rounded-md before:bg-[var(--primary)]
          before:absolute before:top-[0.75rem] before:left-[-1.125rem]
        ">
          {note.data.title}
        </div>
      </div>

      <!-- 描述和元信息 -->
      <div class="onload-animation">
        {note.data.description && (
          <p class="text-neutral-600 dark:text-neutral-400 mb-3">
            {note.data.description}
          </p>
        )}
        
        <div class="flex flex-wrap items-center gap-3 mb-5 text-sm text-neutral-500">
          {note.data.order && (
            <div class="flex items-center gap-1.5">
              <div class="transition h-6 w-6 rounded-md bg-black/5 dark:bg-white/10 text-black/50 dark:text-white/50 flex items-center justify-center">
                <Icon name="material-symbols:numbers" />
              </div>
              <span>第 {note.data.order} 篇</span>
            </div>
          )}
          {note.data.date && (
            <div class="flex items-center gap-1.5">
              <div class="transition h-6 w-6 rounded-md bg-black/5 dark:bg-white/10 text-black/50 dark:text-white/50 flex items-center justify-center">
                <Icon name="material-symbols:calendar-today-outline" />
              </div>
              <span>{note.data.date.toLocaleDateString('zh-CN')}</span>
            </div>
          )}
          {note.data.tags && note.data.tags.length > 0 && (
            <div class="flex items-center gap-1.5">
              <div class="transition h-6 w-6 rounded-md bg-black/5 dark:bg-white/10 text-black/50 dark:text-white/50 flex items-center justify-center">
                <Icon name="material-symbols:label-outline" />
              </div>
              <div class="flex flex-wrap gap-2">
                {note.data.tags.map(tag => (
                  <span class="text-xs px-2.5 py-0.5 rounded bg-neutral-100 dark:bg-neutral-800">
                    #{tag}
                  </span>
                ))}
              </div>
            </div>
          )}
        </div>

        {!note.data.image && <div class="border-[var(--line-divider)] border-dashed border-b-[1px] mb-5"></div>}
      </div>

      <!-- 封面图 -->
      {note.data.image && (
        <ImageWrapper 
          id="post-cover"
          src={note.data.image} 
          basePath={path.join("content/notes/", getDir(note.id))}
          class="mb-8 rounded-xl banner-container onload-animation"
        />
      )}

      <!-- 笔记内容 -->
      <Markdown class="mb-6 markdown-content onload-animation">
        <Content />
      </Markdown>

    </div>
  </div>

  <!-- 上一篇/下一篇导航 -->
  <div class="flex flex-col md:flex-row justify-between mb-4 gap-4 overflow-hidden w-full">
    <a 
      href={prevNote ? `/notes/${prevNote.data.category}/${prevNote.slug.split('/').pop()?.replace(/\.md$/, '')}/` : "#"}
      class:list={["w-full font-bold overflow-hidden active:scale-95", {"pointer-events-none": !prevNote}]}
    >
      {prevNote && (
        <div class="btn-card rounded-2xl w-full h-[3.75rem] max-w-full px-4 flex items-center !justify-start gap-4">
          <Icon name="material-symbols:chevron-left-rounded" class="text-[2rem] text-[var(--primary)]" />
          <div class="overflow-hidden transition overflow-ellipsis whitespace-nowrap max-w-[calc(100%_-_3rem)] text-black/75 dark:text-white/75">
            {prevNote.data.title}
          </div>
        </div>
      )}
    </a>

    <a 
      href={nextNote ? `/notes/${nextNote.data.category}/${nextNote.slug.split('/').pop()?.replace(/\.md$/, '')}/` : "#"}
      class:list={["w-full font-bold overflow-hidden active:scale-95", {"pointer-events-none": !nextNote}]}
    >
      {nextNote && (
        <div class="btn-card rounded-2xl w-full h-[3.75rem] max-w-full px-4 flex items-center !justify-end gap-4">
          <div class="overflow-hidden transition overflow-ellipsis whitespace-nowrap max-w-[calc(100%_-_3rem)] text-black/75 dark:text-white/75">
            {nextNote.data.title}
          </div>
          <Icon name="material-symbols:chevron-right-rounded" class="text-[2rem] text-[var(--primary)]" />
        </div>
      )}
    </a>
  </div>

</MainGridLayout>
